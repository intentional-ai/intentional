
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../">
      
      
        <link rel="next" href="../../../intentional-pipecat/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>API Reference - Intentional</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference-openai" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Intentional" class="md-header__button md-logo" aria-label="Intentional" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Intentional
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/intentional-ai/intentional" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Intentional" class="md-nav__button md-logo" aria-label="Intentional" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Intentional
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/intentional-ai/intentional" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/home/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/concepts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    High-level Concepts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/config-file/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration File
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/plugins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Plugins
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Main Package
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/core-reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Package
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" checked>
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Plugins
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Plugins
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_1" >
        
          
          <label class="md-nav__link" for="__nav_6_3_1" id="__nav_6_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    FastAPI
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_1">
            <span class="md-nav__icon md-icon"></span>
            FastAPI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intentional-fastapi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intentional-fastapi/docs/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_6_3_2" id="__nav_6_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    OpenAI
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_3_2">
            <span class="md-nav__icon md-icon"></span>
            OpenAI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#plugins.intentional-openai" class="md-nav__link">
    <span class="md-ellipsis">
      intentional-openai
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src" class="md-nav__link">
    <span class="md-ellipsis">
      src
    </span>
  </a>
  
    <nav class="md-nav" aria-label="src">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai" class="md-nav__link">
    <span class="md-ellipsis">
      intentional_openai
    </span>
  </a>
  
    <nav class="md-nav" aria-label="intentional_openai">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.__about__" class="md-nav__link">
    <span class="md-ellipsis">
      __about__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api" class="md-nav__link">
    <span class="md-ellipsis">
      chatcompletion_api
    </span>
  </a>
  
    <nav class="md-nav" aria-label="chatcompletion_api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient" class="md-nav__link">
    <span class="md-ellipsis">
      ChatCompletionAPIClient
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ChatCompletionAPIClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.handle_interruption" class="md-nav__link">
    <span class="md-ellipsis">
      handle_interruption
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.send" class="md-nav__link">
    <span class="md-ellipsis">
      send
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.setup_initial_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      setup_initial_prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.update_system_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      update_system_prompt
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api" class="md-nav__link">
    <span class="md-ellipsis">
      realtime_api
    </span>
  </a>
  
    <nav class="md-nav" aria-label="realtime_api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient" class="md-nav__link">
    <span class="md-ellipsis">
      RealtimeAPIClient
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RealtimeAPIClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.connect" class="md-nav__link">
    <span class="md-ellipsis">
      connect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.disconnect" class="md-nav__link">
    <span class="md-ellipsis">
      disconnect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.handle_interruption" class="md-nav__link">
    <span class="md-ellipsis">
      handle_interruption
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.send" class="md-nav__link">
    <span class="md-ellipsis">
      send
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.setup_initial_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      setup_initial_prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.update_system_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      update_system_prompt
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.tools" class="md-nav__link">
    <span class="md-ellipsis">
      tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.tools.to_openai_tool" class="md-nav__link">
    <span class="md-ellipsis">
      to_openai_tool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3_3" id="__nav_6_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Pipecat
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_3">
            <span class="md-nav__icon md-icon"></span>
            Pipecat
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intentional-pipecat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intentional-pipecat/docs/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_4" >
        
          
          <label class="md-nav__link" for="__nav_6_3_4" id="__nav_6_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Telegram UI
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_4">
            <span class="md-nav__icon md-icon"></span>
            Telegram UI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intentional-telegram/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intentional-telegram/docs/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_5" >
        
          
          <label class="md-nav__link" for="__nav_6_3_5" id="__nav_6_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Terminal
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_5">
            <span class="md-nav__icon md-icon"></span>
            Terminal
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intentional-terminal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intentional-terminal/docs/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3_6" >
        
          
          <label class="md-nav__link" for="__nav_6_3_6" id="__nav_6_3_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Textual UI
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3_6">
            <span class="md-nav__icon md-icon"></span>
            Textual UI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intentional-textual-ui/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../intentional-textual-ui/docs/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../CONTRIBUTING/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contribute
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../docs/cla/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLA
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#plugins.intentional-openai" class="md-nav__link">
    <span class="md-ellipsis">
      intentional-openai
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src" class="md-nav__link">
    <span class="md-ellipsis">
      src
    </span>
  </a>
  
    <nav class="md-nav" aria-label="src">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai" class="md-nav__link">
    <span class="md-ellipsis">
      intentional_openai
    </span>
  </a>
  
    <nav class="md-nav" aria-label="intentional_openai">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.__about__" class="md-nav__link">
    <span class="md-ellipsis">
      __about__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api" class="md-nav__link">
    <span class="md-ellipsis">
      chatcompletion_api
    </span>
  </a>
  
    <nav class="md-nav" aria-label="chatcompletion_api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient" class="md-nav__link">
    <span class="md-ellipsis">
      ChatCompletionAPIClient
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ChatCompletionAPIClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.handle_interruption" class="md-nav__link">
    <span class="md-ellipsis">
      handle_interruption
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.send" class="md-nav__link">
    <span class="md-ellipsis">
      send
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.setup_initial_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      setup_initial_prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.update_system_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      update_system_prompt
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api" class="md-nav__link">
    <span class="md-ellipsis">
      realtime_api
    </span>
  </a>
  
    <nav class="md-nav" aria-label="realtime_api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient" class="md-nav__link">
    <span class="md-ellipsis">
      RealtimeAPIClient
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RealtimeAPIClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.connect" class="md-nav__link">
    <span class="md-ellipsis">
      connect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.disconnect" class="md-nav__link">
    <span class="md-ellipsis">
      disconnect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.handle_interruption" class="md-nav__link">
    <span class="md-ellipsis">
      handle_interruption
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.send" class="md-nav__link">
    <span class="md-ellipsis">
      send
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.setup_initial_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      setup_initial_prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.update_system_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      update_system_prompt
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.tools" class="md-nav__link">
    <span class="md-ellipsis">
      tools
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plugins.intentional-openai.src.intentional_openai.tools.to_openai_tool" class="md-nav__link">
    <span class="md-ellipsis">
      to_openai_tool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="api-reference-openai">API Reference - OpenAI<a class="headerlink" href="#api-reference-openai" title="Permanent link">#</a></h1>


<div class="doc doc-object doc-module">



<a id="plugins.intentional-openai"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h2 id="plugins.intentional-openai.src" class="doc doc-heading">
            <code>src</code>


<a href="#plugins.intentional-openai.src" class="headerlink" title="Permanent link">#</a></h2>

    <div class="doc doc-contents ">








  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="plugins.intentional-openai.src.intentional_openai" class="doc doc-heading">
            <code>intentional_openai</code>


<a href="#plugins.intentional-openai.src.intentional_openai" class="headerlink" title="Permanent link">#</a></h3>

    <div class="doc doc-contents ">

        <p>Init file for <code>intentional_openai</code>.</p>








  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h4 id="plugins.intentional-openai.src.intentional_openai.__about__" class="doc doc-heading">
            <code>__about__</code>


<a href="#plugins.intentional-openai.src.intentional_openai.__about__" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

        <p>Package descriptors for intentional-openai.</p>








  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="plugins.intentional-openai.src.intentional_openai.chatcompletion_api" class="doc doc-heading">
            <code>chatcompletion_api</code>


<a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

        <p>Client for OpenAI's Chat Completion API.</p>








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h5 id="plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient" class="doc doc-heading">
            <code>ChatCompletionAPIClient</code>


<a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient" class="headerlink" title="Permanent link">#</a></h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="intentional_core.LLMClient">LLMClient</span></code></p>


        <p>A client for interacting with the OpenAI Chat Completion API.</p>






              <details class="quote">
                <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/chatcompletion_api.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ChatCompletionAPIClient</span><span class="p">(</span><span class="n">LLMClient</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A client for interacting with the OpenAI Chat Completion API.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;openai&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="s2">&quot;BotStructure&quot;</span><span class="p">,</span>
        <span class="n">intent_router</span><span class="p">:</span> <span class="n">IntentRouter</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A client for interacting with the OpenAI Chat Completion API.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent: The parent bot structure.</span>
<span class="sd">            intent_router: The intent router.</span>
<span class="sd">            config: The configuration dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading ChatCompletionAPIClient from config&quot;</span><span class="p">,</span> <span class="n">llm_client_config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">intent_router</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ChatCompletionAPIClient requires a &#39;name&#39; configuration key to know which LLM to use.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;realtime&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;ChatCompletionAPIClient doesn&#39;t support Realtime API. &quot;</span>
                <span class="s2">&quot;To use the Realtime API, use RealtimeAPIClient instead (client: openai_realtime)&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key_name&quot;</span><span class="p">,</span> <span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;ChatCompletionAPIClient requires an API key to authenticate with OpenAI. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;The provided environment variable name (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="si">}</span><span class="s2">) is not set or is empty.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">AsyncOpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_initial_prompt</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">}]</span>

    <span class="k">def</span> <span class="nf">setup_initial_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup initial prompt and tools. Used also after conversation end to reset the state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">get_prompt</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">current_stage</span><span class="o">.</span><span class="n">tools</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">}]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initial system prompt set&quot;</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle events from the LLM by either processing them internally or by translating them into higher-level</span>
<span class="sd">        events that the BotStructure class can understand, then re-emitting them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ChatCompletionAPIClient.run() is no-op for now&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_system_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the system prompt in the LLM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">}]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_system_prompt_updated&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;system_prompt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">})</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_interruption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lenght_to_interruption</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle an interruption while rendering the output to the user.</span>

<span class="sd">        Args:</span>
<span class="sd">            lenght_to_interruption: The length of the data that was produced to the user before the interruption.</span>
<span class="sd">                This value could be number of characters, number of words, milliseconds, number of audio frames, etc.</span>
<span class="sd">                depending on the bot structure that implements it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;TODO! Implement handle_interruption in ChatCompletionAPIClient&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a message to the LLM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_llm_starts_generating_response&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Generate a response</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;text_message&quot;</span><span class="p">]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># Unwrap the response to make sure it contains no function calls to handle</span>
        <span class="n">call_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">function_args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">assistant_response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">call_id</span><span class="p">:</span>
                <span class="n">call_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;choices&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;tool_calls&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">delta</span><span class="p">:</span>
                <span class="c1"># If this is not a function call, just stream out</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_text_message_from_llm&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">delta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)})</span>
                <span class="n">assistant_response</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO handle multiple parallel function calls</span>
                <span class="k">if</span> <span class="n">delta</span><span class="p">[</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta</span><span class="p">[</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TODO: Multiple parallel function calls not supported yet. Please open an issue.&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Multiple parallel function calls&quot;</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
                <span class="c1"># Consume the response to understand which tool to call with which parameters</span>
                <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">delta</span><span class="p">[</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">function_name</span><span class="p">:</span>
                        <span class="n">function_name</span> <span class="o">=</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                    <span class="n">function_args</span> <span class="o">+=</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">function_name</span><span class="p">:</span>
            <span class="c1"># If there was no function call, update the conversation history and return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">assistant_response</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise deal with the function call</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_function_call</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">call_id</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">function_args</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_llm_stops_generating_response&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a response to a message.</span>

<span class="sd">        Args:</span>
<span class="sd">            message: The message to respond to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="p">,</span>
            <span class="n">messages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation</span> <span class="o">+</span> <span class="p">[</span><span class="n">message</span><span class="p">],</span>
            <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">tools</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="n">to_openai_tool</span><span class="p">(</span><span class="n">t</span><span class="p">)}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
            <span class="n">tool_choice</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_handle_function_call</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">message</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">function_args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle a function call from the LLM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Function call detected&quot;</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span>
            <span class="n">function_args</span><span class="o">=</span><span class="n">function_args</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">function_args</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">function_args</span><span class="p">)</span>

        <span class="c1"># Routing function call - this is special because it should not be recorded in the conversation history</span>
        <span class="k">if</span> <span class="n">function_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_route</span><span class="p">(</span><span class="n">function_args</span><span class="p">)</span>
            <span class="c1"># Send the same message again with the new system prompt and no trace of the routing call.</span>
            <span class="c1"># We don&#39;t append the user message to the history in order to avoid message duplication.</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;text_message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">})</span>

        <span class="c1"># Check if the conversation should end</span>
        <span class="k">elif</span> <span class="n">function_name</span> <span class="o">==</span> <span class="n">EndConversationTool</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">EndConversationTool</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_initial_prompt</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_conversation_ended&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle a regular function call - this one shows up in the history as normal</span>
            <span class="c1"># so we start by appending the user message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tool</span><span class="p">(</span><span class="n">call_id</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">function_args</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;text_message&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">),</span>
                        <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">call_id</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routing_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the router to determine the next system prompt and tools to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">routing_info</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_system_prompt</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;System prompt updated&quot;</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tools updated&quot;</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_call_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call_id</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">function_args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call a tool with the given arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            call_id: The ID of the tool call.</span>
<span class="sd">            function_name: The name of the tool function to call.</span>
<span class="sd">            function_args: The arguments to pass to the tool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_tool_invoked&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">function_args</span><span class="p">})</span>

        <span class="c1"># Record the tool invocation in the conversation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">call_id</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">function_args</span><span class="p">),</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">}</span>
                <span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Get the tool output</span>
        <span class="k">if</span> <span class="n">function_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The LLM called a non-existing tool.&quot;</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="n">function_name</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calling tool&quot;</span><span class="p">,</span> <span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span> <span class="n">function_args</span><span class="o">=</span><span class="n">function_args</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">function_args</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool run&quot;</span><span class="p">,</span> <span class="n">tool_output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">intent_router</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

<a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.__init__" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>A client for interacting with the OpenAI Chat Completion API.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>parent</code>
            </td>
            <td>
                  <code><span title="intentional_core.bot_structures.bot_structure.BotStructure">BotStructure</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The parent bot structure.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>intent_router</code>
            </td>
            <td>
                  <code><span title="intentional_core.intent_routing.IntentRouter">IntentRouter</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The intent router.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configuration dictionary.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/chatcompletion_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="s2">&quot;BotStructure&quot;</span><span class="p">,</span>
    <span class="n">intent_router</span><span class="p">:</span> <span class="n">IntentRouter</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A client for interacting with the OpenAI Chat Completion API.</span>

<span class="sd">    Args:</span>
<span class="sd">        parent: The parent bot structure.</span>
<span class="sd">        intent_router: The intent router.</span>
<span class="sd">        config: The configuration dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading ChatCompletionAPIClient from config&quot;</span><span class="p">,</span> <span class="n">llm_client_config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">intent_router</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ChatCompletionAPIClient requires a &#39;name&#39; configuration key to know which LLM to use.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;realtime&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;ChatCompletionAPIClient doesn&#39;t support Realtime API. &quot;</span>
            <span class="s2">&quot;To use the Realtime API, use RealtimeAPIClient instead (client: openai_realtime)&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key_name&quot;</span><span class="p">,</span> <span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;ChatCompletionAPIClient requires an API key to authenticate with OpenAI. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;The provided environment variable name (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="si">}</span><span class="s2">) is not set or is empty.&quot;</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">AsyncOpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setup_initial_prompt</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">}]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.handle_interruption" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_interruption</span><span class="p">(</span><span class="n">lenght_to_interruption</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.handle_interruption" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Handle an interruption while rendering the output to the user.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lenght_to_interruption</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The length of the data that was produced to the user before the interruption.
This value could be number of characters, number of words, milliseconds, number of audio frames, etc.
depending on the bot structure that implements it.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/chatcompletion_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">handle_interruption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lenght_to_interruption</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle an interruption while rendering the output to the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        lenght_to_interruption: The length of the data that was produced to the user before the interruption.</span>
<span class="sd">            This value could be number of characters, number of words, milliseconds, number of audio frames, etc.</span>
<span class="sd">            depending on the bot structure that implements it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;TODO! Implement handle_interruption in ChatCompletionAPIClient&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.run" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Handle events from the LLM by either processing them internally or by translating them into higher-level
events that the BotStructure class can understand, then re-emitting them.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/chatcompletion_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle events from the LLM by either processing them internally or by translating them into higher-level</span>
<span class="sd">    events that the BotStructure class can understand, then re-emitting them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ChatCompletionAPIClient.run() is no-op for now&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.send" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.send" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Send a message to the LLM.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/chatcompletion_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a message to the LLM.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_llm_starts_generating_response&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Generate a response</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;text_message&quot;</span><span class="p">]</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># Unwrap the response to make sure it contains no function calls to handle</span>
    <span class="n">call_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">function_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">function_args</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">assistant_response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">call_id</span><span class="p">:</span>
            <span class="n">call_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;choices&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;tool_calls&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">delta</span><span class="p">:</span>
            <span class="c1"># If this is not a function call, just stream out</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_text_message_from_llm&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">delta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)})</span>
            <span class="n">assistant_response</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO handle multiple parallel function calls</span>
            <span class="k">if</span> <span class="n">delta</span><span class="p">[</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">delta</span><span class="p">[</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TODO: Multiple parallel function calls not supported yet. Please open an issue.&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Multiple parallel function calls&quot;</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">)</span>
            <span class="c1"># Consume the response to understand which tool to call with which parameters</span>
            <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">delta</span><span class="p">[</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">function_name</span><span class="p">:</span>
                    <span class="n">function_name</span> <span class="o">=</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="n">function_args</span> <span class="o">+=</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">function_name</span><span class="p">:</span>
        <span class="c1"># If there was no function call, update the conversation history and return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">assistant_response</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Otherwise deal with the function call</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_function_call</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">call_id</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">function_args</span><span class="p">)</span>

    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_llm_stops_generating_response&quot;</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.setup_initial_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">setup_initial_prompt</span><span class="p">()</span></code>

<a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.setup_initial_prompt" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Setup initial prompt and tools. Used also after conversation end to reset the state.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/chatcompletion_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setup_initial_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup initial prompt and tools. Used also after conversation end to reset the state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">get_prompt</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">current_stage</span><span class="o">.</span><span class="n">tools</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">}]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initial system prompt set&quot;</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.update_system_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_system_prompt</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#plugins.intentional-openai.src.intentional_openai.chatcompletion_api.ChatCompletionAPIClient.update_system_prompt" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Update the system prompt in the LLM.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/chatcompletion_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">update_system_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the system prompt in the LLM.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">}]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_system_prompt_updated&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;system_prompt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="plugins.intentional-openai.src.intentional_openai.realtime_api" class="doc doc-heading">
            <code>realtime_api</code>


<a href="#plugins.intentional-openai.src.intentional_openai.realtime_api" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

        <p>Client for OpenAI's Realtime API.</p>








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h5 id="plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient" class="doc doc-heading">
            <code>RealtimeAPIClient</code>


<a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient" class="headerlink" title="Permanent link">#</a></h5>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="intentional_core.LLMClient">LLMClient</span></code></p>


        <p>A client for interacting with the OpenAI Realtime API that lets you manage the WebSocket connection, send text and
audio data, and handle responses and events.</p>






              <details class="quote">
                <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/realtime_api.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">RealtimeAPIClient</span><span class="p">(</span><span class="n">LLMClient</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A client for interacting with the OpenAI Realtime API that lets you manage the WebSocket connection, send text and</span>
<span class="sd">    audio data, and handle responses and events.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;openai_realtime&quot;</span>

    <span class="n">events_translation</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;on_error&quot;</span><span class="p">,</span>
        <span class="s2">&quot;response.text.delta&quot;</span><span class="p">:</span> <span class="s2">&quot;on_text_message_from_llm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;response.audio.delta&quot;</span><span class="p">:</span> <span class="s2">&quot;on_audio_message_from_llm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;response.created&quot;</span><span class="p">:</span> <span class="s2">&quot;on_llm_starts_generating_response&quot;</span><span class="p">,</span>
        <span class="s2">&quot;response.done&quot;</span><span class="p">:</span> <span class="s2">&quot;on_llm_stops_generating_response&quot;</span><span class="p">,</span>
        <span class="s2">&quot;input_audio_buffer.speech_started&quot;</span><span class="p">:</span> <span class="s2">&quot;on_user_speech_started&quot;</span><span class="p">,</span>
        <span class="s2">&quot;input_audio_buffer.speech_stopped&quot;</span><span class="p">:</span> <span class="s2">&quot;on_user_speech_ended&quot;</span><span class="p">,</span>
        <span class="s2">&quot;conversation.item.input_audio_transcription.completed&quot;</span><span class="p">:</span> <span class="s2">&quot;on_user_speech_transcribed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;response.audio_transcript.done&quot;</span><span class="p">:</span> <span class="s2">&quot;on_llm_speech_transcribed&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">intent_router</span><span class="p">:</span> <span class="n">IntentRouter</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A client for interacting with the OpenAI Realtime API that lets you manage the WebSocket connection, send text</span>
<span class="sd">        and audio data, and handle responses and events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2"> from config&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">llm_client_config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">intent_router</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;RealtimeAPIClient requires a &#39;name&#39; configuration key to know which LLM to use.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;realtime&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;RealtimeAPIClient requires a &#39;realtime&#39; LLM to use the Realtime API. &quot;</span>
                <span class="s2">&quot;To use any other OpenAI LLM, use the OpenAIClient instead.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key_name&quot;</span><span class="p">,</span> <span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;RealtimeAPIClient requires an API key to authenticate with OpenAI. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;The provided environment variable name (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="si">}</span><span class="s2">) is not set or is empty.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voice</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;voice&quot;</span><span class="p">,</span> <span class="s2">&quot;alloy&quot;</span><span class="p">)</span>

        <span class="c1"># WebSocket connection data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;wss://api.openai.com/v1/realtime&quot;</span>

        <span class="c1"># Track current response state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updating_system_prompt</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_response_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_item_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Intent routering data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span> <span class="o">=</span> <span class="n">intent_router</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_initial_prompt</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setup_initial_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup initial prompt and tools. Used also after conversation end to reset the state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">get_prompt</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">current_stage</span><span class="o">.</span><span class="n">tools</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Establish WebSocket connection with the Realtime API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing websocket connection to OpenAI Realtime API&quot;</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">?model=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;OpenAI-Beta&quot;</span><span class="p">:</span> <span class="s2">&quot;realtime=v1&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websockets</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">extra_headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_session</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;modalities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;audio&quot;</span><span class="p">],</span>
                <span class="s2">&quot;instructions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">,</span>
                <span class="s2">&quot;voice&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice</span><span class="p">,</span>
                <span class="s2">&quot;input_audio_format&quot;</span><span class="p">:</span> <span class="s2">&quot;pcm16&quot;</span><span class="p">,</span>
                <span class="s2">&quot;output_audio_format&quot;</span><span class="p">:</span> <span class="s2">&quot;pcm16&quot;</span><span class="p">,</span>
                <span class="s2">&quot;input_audio_transcription&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;whisper-1&quot;</span><span class="p">},</span>
                <span class="s2">&quot;turn_detection&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;server_vad&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s2">&quot;prefix_padding_ms&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                    <span class="s2">&quot;silence_duration_ms&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">to_openai_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                <span class="s2">&quot;tool_choice&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># Flag that we&#39;re connecting and look for this event in the run loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the WebSocket connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Disconnecting from OpenAI Realtime API&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempted disconnection of a OpenAIRealtimeAPIClient that was never connected, nothing done.&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_llm_disconnection&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pylint: disable=too-many-branches, too-many-statements</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles events coming from the WebSocket connection.</span>

<span class="sd">        This method is an infinite loop that listens for messages from the WebSocket connection and processes them</span>
<span class="sd">        accordingly. It also triggers the event handlers for the corresponding event types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">event_name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received event&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="o">=</span><span class="n">event_name</span><span class="p">)</span>

                <span class="c1"># Handle errors</span>
                <span class="k">if</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;An error response was returned&quot;</span><span class="p">,</span> <span class="n">event_data</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;conversation.item.input_audio_transcription.failed&quot;</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;An error happened during transcription&quot;</span><span class="p">,</span> <span class="n">event_data</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;session.updated&quot;</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Session configuration updated&quot;</span><span class="p">,</span> <span class="n">event_data</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
                    <span class="c1"># Check why we updated the session and emit the corresponding event</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_llm_connection&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updating_system_prompt</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_updating_system_prompt</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                            <span class="s2">&quot;on_system_prompt_updated&quot;</span><span class="p">,</span>
                            <span class="p">{</span><span class="s2">&quot;system_prompt&quot;</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">][</span><span class="s2">&quot;instructions&quot;</span><span class="p">]},</span>
                        <span class="p">)</span>

                <span class="c1"># Track agent response state</span>
                <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;response.created&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_response_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Agent started responding. Response created.&quot;</span><span class="p">,</span>
                        <span class="n">response_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_response_id</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;response.output_item.added&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_current_item_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Agent is responding. Added response item.&quot;</span><span class="p">,</span>
                        <span class="n">response_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_item_id</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;response.done&quot;</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Agent finished generating a response.&quot;</span><span class="p">,</span>
                        <span class="n">response_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_item_id</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># Tool call</span>
                <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;response.function_call_arguments.done&quot;</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tool</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

                <span class="c1"># Events from VAD related to the user&#39;s input</span>
                <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;input_audio_buffer.speech_started&quot;</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Speech detected.&quot;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;input_audio_buffer.speech_stopped&quot;</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Speech ended.&quot;</span><span class="p">)</span>

                <span class="c1"># Decode the audio from base64</span>
                <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;response.audio.delta&quot;</span><span class="p">:</span>
                    <span class="n">audio_b64</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">audio_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">audio_b64</span><span class="p">)</span>
                    <span class="n">event</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio_bytes</span>

                <span class="c1"># Relay the event to the parent BotStructure - regardless whether it was processed above or not</span>
                <span class="k">if</span> <span class="n">event_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_translation</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Translating event&quot;</span><span class="p">,</span>
                        <span class="n">old_event_name</span><span class="o">=</span><span class="n">event_name</span><span class="p">,</span>
                        <span class="n">new_event_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">events_translation</span><span class="p">[</span><span class="n">event_name</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_translation</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events_translation</span><span class="p">[</span><span class="n">event_name</span><span class="p">],</span> <span class="n">event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending native event to parent&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="o">=</span><span class="n">event_name</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">websockets</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionClosedOK</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Connection closed.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error in message handling&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;.run() exited without errors.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stream data to the API.</span>

<span class="sd">        Args:</span>
<span class="sd">            data:</span>
<span class="sd">                The data chunk to stream. It should be in the format {&quot;audio&quot;: bytes}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;audio_chunk&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_audio_stream</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;audio_chunk&quot;</span><span class="p">])</span>
        <span class="c1"># if &quot;audio_message&quot; in data:</span>
        <span class="c1">#     await self._send_audio(data[&quot;audio_message&quot;])</span>
        <span class="c1"># if &quot;text_message&quot; in data:</span>
        <span class="c1">#     await self._send_text_message(data[&quot;text_message&quot;])</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_system_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the system prompt to use in the conversation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting new system prompt&quot;</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting new tools&quot;</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_session</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;instructions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">,</span>
                <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">to_openai_tool</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># Flag that we&#39;re updating the system prompt and look for this event in the run loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updating_system_prompt</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_interruption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lenght_to_interruption</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle user interruption of the current response.</span>

<span class="sd">        Args:</span>
<span class="sd">            lenght_to_interruption (int):</span>
<span class="sd">                The length in milliseconds of the audio that was played to the user before the interruption.</span>
<span class="sd">                May be zero if the interruption happened before any audio was played.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;[Handling interruption at </span><span class="si">%s</span><span class="s2"> ms]&quot;</span><span class="p">,</span>
            <span class="n">lenght_to_interruption</span><span class="p">,</span>
            <span class="n">interruption_time</span><span class="o">=</span><span class="n">lenght_to_interruption</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Cancel the current response</span>
        <span class="c1"># Cancelling responses is effective when the response is still being generated by the LLM.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_response_id</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Cancelling response due to a user&#39;s interruption.&quot;</span><span class="p">,</span>
                <span class="n">response_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_response_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;response.cancel&quot;</span><span class="p">}</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No response ID found to cancel.&quot;</span><span class="p">)</span>

        <span class="c1"># Truncate the conversation item to what was actually played</span>
        <span class="c1"># Truncating the response is effective when the response has already been generated by the LLM and is being</span>
        <span class="c1"># played out.</span>
        <span class="k">if</span> <span class="n">lenght_to_interruption</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Truncating the response due to a user&#39;s interruption at </span><span class="si">%s</span><span class="s2"> ms&quot;</span><span class="p">,</span>
                <span class="n">lenght_to_interruption</span><span class="p">,</span>
                <span class="n">interruption_time</span><span class="o">=</span><span class="n">lenght_to_interruption</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;conversation.item.truncate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_item_id</span><span class="p">,</span>
                <span class="s2">&quot;content_index&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;audio_end_ms&quot;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">lenght_to_interruption</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_update_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update session configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            config (Dict[str, Any]):</span>
<span class="sd">                The new session configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;session.update&quot;</span><span class="p">,</span> <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_text_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send text message to the API.</span>

<span class="sd">        Args:</span>
<span class="sd">            text (str):</span>
<span class="sd">                The text message to send.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;conversation.item.create&quot;</span><span class="p">,</span>
            <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;input_text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">}],</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_response_from_llm</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_audio_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">audio_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">audio_b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">audio_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">append_event</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;input_audio_buffer.append&quot;</span><span class="p">,</span> <span class="s2">&quot;audio&quot;</span><span class="p">:</span> <span class="n">audio_b64</span><span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">append_event</span><span class="p">))</span>

    <span class="c1"># async def _send_audio_message(self, audio_bytes: bytes) -&gt; None:</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Send audio data to the API.</span>

    <span class="c1">#     Args:</span>
    <span class="c1">#         audio_bytes (bytes):</span>
    <span class="c1">#             The audio data to send.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # Convert audio to required format (24kHz, mono, PCM16)</span>
    <span class="c1">#     audio = AudioSegment.from_file(io.BytesIO(audio_bytes))</span>
    <span class="c1">#     audio = audio.set_frame_rate(24000).set_channels(1).set_sample_width(2)</span>
    <span class="c1">#     pcm_data = base64.b64encode(audio.raw_data).decode()</span>

    <span class="c1">#     # Append audio to buffer</span>
    <span class="c1">#     append_event = {&quot;type&quot;: &quot;input_audio_buffer.append&quot;, &quot;audio&quot;: pcm_data}</span>
    <span class="c1">#     await self.ws.send(json.dumps(append_event))</span>

    <span class="c1">#     # Commit the buffer</span>
    <span class="c1">#     commit_event = {&quot;type&quot;: &quot;input_audio_buffer.commit&quot;}</span>
    <span class="c1">#     await self.ws.send(json.dumps(commit_event))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_function_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send function call result back to the API.</span>

<span class="sd">        Args:</span>
<span class="sd">            call_id (str):</span>
<span class="sd">                The ID of the function call.</span>
<span class="sd">            result (Any):</span>
<span class="sd">                The result of the function call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;conversation.item.create&quot;</span><span class="p">,</span>
            <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function_call_output&quot;</span><span class="p">,</span>
                <span class="s2">&quot;call_id&quot;</span><span class="p">:</span> <span class="n">call_id</span><span class="p">,</span>
                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_response_from_llm</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_request_response_from_llm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asks the LLM for a response to the messages it just received.</span>
<span class="sd">        You need to call this function right after sending a messages that is not streamed like the audio (where the</span>
<span class="sd">        LLM&#39;s VAD would decide when to reply instead).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;response.create&quot;</span><span class="p">,</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;modalities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;audio&quot;</span><span class="p">]},</span>
        <span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_call_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls the tool requested by the LLM.</span>

<span class="sd">        Args:</span>
<span class="sd">            event (Dict[str, Any]):</span>
<span class="sd">                The event containing the tool call information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">call_id</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;call_id&quot;</span><span class="p">]</span>
        <span class="n">tool_name</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">tool_arguments</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Calling tool&quot;</span><span class="p">,</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="n">tool_name</span><span class="p">,</span>
            <span class="n">tool_arguments</span><span class="o">=</span><span class="n">tool_arguments</span><span class="p">,</span>
            <span class="n">call_id</span><span class="o">=</span><span class="n">call_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Check if it&#39;s the router</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tool_arguments</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_system_prompt</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_function_result</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;call_id&quot;</span><span class="p">],</span> <span class="s2">&quot;ok&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Check if the conversation should end</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="n">EndConversationTool</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">EndConversationTool</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="c1"># await self.disconnect()</span>
            <span class="c1"># self.setup_initial_prompt()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_conversation_ended&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># await self.connect()</span>
            <span class="k">return</span>

        <span class="c1"># Emit the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_tool_invoked&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool_name</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">tool_arguments</span><span class="p">})</span>

        <span class="c1"># Make sure the tool actually exists</span>
        <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Tool &#39;</span><span class="si">%s</span><span class="s2">&#39; not found in the list of available tools.&quot;</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_function_result</span><span class="p">(</span><span class="n">call_id</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Error: Tool </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="c1"># Invoke the tool and send back the output</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tool_arguments</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tool run&quot;</span><span class="p">,</span> <span class="n">tool_name</span><span class="o">=</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">tool_output</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_function_result</span><span class="p">(</span><span class="n">call_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">intent_router</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

<a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.__init__" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>A client for interacting with the OpenAI Realtime API that lets you manage the WebSocket connection, send text
and audio data, and handle responses and events.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/realtime_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">intent_router</span><span class="p">:</span> <span class="n">IntentRouter</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A client for interacting with the OpenAI Realtime API that lets you manage the WebSocket connection, send text</span>
<span class="sd">    and audio data, and handle responses and events.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2"> from config&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">llm_client_config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">intent_router</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;RealtimeAPIClient requires a &#39;name&#39; configuration key to know which LLM to use.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;realtime&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;RealtimeAPIClient requires a &#39;realtime&#39; LLM to use the Realtime API. &quot;</span>
            <span class="s2">&quot;To use any other OpenAI LLM, use the OpenAIClient instead.&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key_name&quot;</span><span class="p">,</span> <span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;RealtimeAPIClient requires an API key to authenticate with OpenAI. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;The provided environment variable name (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="si">}</span><span class="s2">) is not set or is empty.&quot;</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">voice</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;voice&quot;</span><span class="p">,</span> <span class="s2">&quot;alloy&quot;</span><span class="p">)</span>

    <span class="c1"># WebSocket connection data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;wss://api.openai.com/v1/realtime&quot;</span>

    <span class="c1"># Track current response state</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_updating_system_prompt</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_response_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_item_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Intent routering data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span> <span class="o">=</span> <span class="n">intent_router</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setup_initial_prompt</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.connect" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">connect</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.connect" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Establish WebSocket connection with the Realtime API.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/realtime_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Establish WebSocket connection with the Realtime API.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing websocket connection to OpenAI Realtime API&quot;</span><span class="p">)</span>

    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">?model=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OpenAI-Beta&quot;</span><span class="p">:</span> <span class="s2">&quot;realtime=v1&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websockets</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">extra_headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_session</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;modalities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;audio&quot;</span><span class="p">],</span>
            <span class="s2">&quot;instructions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">,</span>
            <span class="s2">&quot;voice&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voice</span><span class="p">,</span>
            <span class="s2">&quot;input_audio_format&quot;</span><span class="p">:</span> <span class="s2">&quot;pcm16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;output_audio_format&quot;</span><span class="p">:</span> <span class="s2">&quot;pcm16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;input_audio_transcription&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;whisper-1&quot;</span><span class="p">},</span>
            <span class="s2">&quot;turn_detection&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;server_vad&quot;</span><span class="p">,</span>
                <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;prefix_padding_ms&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                <span class="s2">&quot;silence_duration_ms&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">to_openai_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
            <span class="s2">&quot;tool_choice&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="c1"># Flag that we&#39;re connecting and look for this event in the run loop</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.disconnect" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">disconnect</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.disconnect" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Close the WebSocket connection.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/realtime_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Close the WebSocket connection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Disconnecting from OpenAI Realtime API&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempted disconnection of a OpenAIRealtimeAPIClient that was never connected, nothing done.&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_llm_disconnection&quot;</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.handle_interruption" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_interruption</span><span class="p">(</span><span class="n">lenght_to_interruption</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.handle_interruption" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Handle user interruption of the current response.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lenght_to_interruption</code>
            </td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The length in milliseconds of the audio that was played to the user before the interruption.
May be zero if the interruption happened before any audio was played.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/realtime_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">handle_interruption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lenght_to_interruption</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle user interruption of the current response.</span>

<span class="sd">    Args:</span>
<span class="sd">        lenght_to_interruption (int):</span>
<span class="sd">            The length in milliseconds of the audio that was played to the user before the interruption.</span>
<span class="sd">            May be zero if the interruption happened before any audio was played.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;[Handling interruption at </span><span class="si">%s</span><span class="s2"> ms]&quot;</span><span class="p">,</span>
        <span class="n">lenght_to_interruption</span><span class="p">,</span>
        <span class="n">interruption_time</span><span class="o">=</span><span class="n">lenght_to_interruption</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Cancel the current response</span>
    <span class="c1"># Cancelling responses is effective when the response is still being generated by the LLM.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_response_id</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Cancelling response due to a user&#39;s interruption.&quot;</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_response_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;response.cancel&quot;</span><span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No response ID found to cancel.&quot;</span><span class="p">)</span>

    <span class="c1"># Truncate the conversation item to what was actually played</span>
    <span class="c1"># Truncating the response is effective when the response has already been generated by the LLM and is being</span>
    <span class="c1"># played out.</span>
    <span class="k">if</span> <span class="n">lenght_to_interruption</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Truncating the response due to a user&#39;s interruption at </span><span class="si">%s</span><span class="s2"> ms&quot;</span><span class="p">,</span>
            <span class="n">lenght_to_interruption</span><span class="p">,</span>
            <span class="n">interruption_time</span><span class="o">=</span><span class="n">lenght_to_interruption</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;conversation.item.truncate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;item_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_item_id</span><span class="p">,</span>
            <span class="s2">&quot;content_index&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;audio_end_ms&quot;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">lenght_to_interruption</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.run" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Handles events coming from the WebSocket connection.</p>
<p>This method is an infinite loop that listens for messages from the WebSocket connection and processes them
accordingly. It also triggers the event handlers for the corresponding event types.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/realtime_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pylint: disable=too-many-branches, too-many-statements</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles events coming from the WebSocket connection.</span>

<span class="sd">    This method is an infinite loop that listens for messages from the WebSocket connection and processes them</span>
<span class="sd">    accordingly. It also triggers the event handlers for the corresponding event types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">event_name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Received event&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="o">=</span><span class="n">event_name</span><span class="p">)</span>

            <span class="c1"># Handle errors</span>
            <span class="k">if</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;An error response was returned&quot;</span><span class="p">,</span> <span class="n">event_data</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;conversation.item.input_audio_transcription.failed&quot;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;An error happened during transcription&quot;</span><span class="p">,</span> <span class="n">event_data</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;session.updated&quot;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Session configuration updated&quot;</span><span class="p">,</span> <span class="n">event_data</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
                <span class="c1"># Check why we updated the session and emit the corresponding event</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;on_llm_connection&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updating_system_prompt</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_updating_system_prompt</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                        <span class="s2">&quot;on_system_prompt_updated&quot;</span><span class="p">,</span>
                        <span class="p">{</span><span class="s2">&quot;system_prompt&quot;</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">][</span><span class="s2">&quot;instructions&quot;</span><span class="p">]},</span>
                    <span class="p">)</span>

            <span class="c1"># Track agent response state</span>
            <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;response.created&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_response_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Agent started responding. Response created.&quot;</span><span class="p">,</span>
                    <span class="n">response_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_response_id</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;response.output_item.added&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_item_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Agent is responding. Added response item.&quot;</span><span class="p">,</span>
                    <span class="n">response_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_item_id</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;response.done&quot;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Agent finished generating a response.&quot;</span><span class="p">,</span>
                    <span class="n">response_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_item_id</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Tool call</span>
            <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;response.function_call_arguments.done&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tool</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="c1"># Events from VAD related to the user&#39;s input</span>
            <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;input_audio_buffer.speech_started&quot;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Speech detected.&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;input_audio_buffer.speech_stopped&quot;</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Speech ended.&quot;</span><span class="p">)</span>

            <span class="c1"># Decode the audio from base64</span>
            <span class="k">elif</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;response.audio.delta&quot;</span><span class="p">:</span>
                <span class="n">audio_b64</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">audio_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">audio_b64</span><span class="p">)</span>
                <span class="n">event</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio_bytes</span>

            <span class="c1"># Relay the event to the parent BotStructure - regardless whether it was processed above or not</span>
            <span class="k">if</span> <span class="n">event_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_translation</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Translating event&quot;</span><span class="p">,</span>
                    <span class="n">old_event_name</span><span class="o">=</span><span class="n">event_name</span><span class="p">,</span>
                    <span class="n">new_event_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">events_translation</span><span class="p">[</span><span class="n">event_name</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_translation</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events_translation</span><span class="p">[</span><span class="n">event_name</span><span class="p">],</span> <span class="n">event</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending native event to parent&quot;</span><span class="p">,</span> <span class="n">event_name</span><span class="o">=</span><span class="n">event_name</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">websockets</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionClosedOK</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Connection closed.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error in message handling&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;.run() exited without errors.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.send" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.send" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Stream data to the API.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data chunk to stream. It should be in the format {"audio": bytes}.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/realtime_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stream data to the API.</span>

<span class="sd">    Args:</span>
<span class="sd">        data:</span>
<span class="sd">            The data chunk to stream. It should be in the format {&quot;audio&quot;: bytes}.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;audio_chunk&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_audio_stream</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;audio_chunk&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.setup_initial_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">setup_initial_prompt</span><span class="p">()</span></code>

<a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.setup_initial_prompt" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Setup initial prompt and tools. Used also after conversation end to reset the state.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/realtime_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setup_initial_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup initial prompt and tools. Used also after conversation end to reset the state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">get_prompt</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_router</span><span class="o">.</span><span class="n">current_stage</span><span class="o">.</span><span class="n">tools</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h6 id="plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.update_system_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_system_prompt</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#plugins.intentional-openai.src.intentional_openai.realtime_api.RealtimeAPIClient.update_system_prompt" class="headerlink" title="Permanent link">#</a></h6>


    <div class="doc doc-contents ">

        <p>Update the system prompt to use in the conversation.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/realtime_api.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">update_system_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the system prompt to use in the conversation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting new system prompt&quot;</span><span class="p">,</span> <span class="n">system_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting new tools&quot;</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_session</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;instructions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">,</span>
            <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">to_openai_tool</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="c1"># Flag that we&#39;re updating the system prompt and look for this event in the run loop</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_updating_system_prompt</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="plugins.intentional-openai.src.intentional_openai.tools" class="doc doc-heading">
            <code>tools</code>


<a href="#plugins.intentional-openai.src.intentional_openai.tools" class="headerlink" title="Permanent link">#</a></h4>

    <div class="doc doc-contents ">

        <p>Tool utilities to interact with tools in OpenAI.</p>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h5 id="plugins.intentional-openai.src.intentional_openai.tools.to_openai_tool" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_openai_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span></code>

<a href="#plugins.intentional-openai.src.intentional_openai.tools.to_openai_tool" class="headerlink" title="Permanent link">#</a></h5>


    <div class="doc doc-contents ">

        <p>The tool definition required by OpenAI.</p>

            <details class="quote">
              <summary>Source code in <code>plugins/intentional-openai/src/intentional_openai/tools.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">to_openai_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">:</span> <span class="n">Tool</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The tool definition required by OpenAI.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">tool</span><span class="o">.</span><span class="n">parameters</span>
            <span class="p">},</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">tool</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">required</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>